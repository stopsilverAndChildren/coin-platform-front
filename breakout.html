<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <!-- JS -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <!-- <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script> -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.js"></script>
    <title>Break out Game</title>
    <style>
        .grid {
          position: absolute;
          width: 560px;
          height: 300px;
          border: solid 1px black;
          margin-top: 100px;
        }
        
        .user {
          position: absolute;
          width: 100px;
          height: 20px;
          background-color: blueviolet;
        }
        
        .block {
          position: absolute;
          width: 100px;
          height: 20px;
          background-color: blue;
        }
        
        .ball {
          position: absolute;
          width: 20px;
          height: 20px;
          border-radius: 10px;
          background-color: red;
        }
    </style>

</head>
<body>
    <div class="grid" style="position: relative;">
        <div class="score" style="position: absolute; bottom: 20px; left: 20px;" >0</div>
    </div>

    <script>
        const grid = document.querySelector(".grid");
        // const axios = require('axios');
        const scoreDisplay = document.querySelector(".score");
        const blockWidth = 100;
        const blockHeight = 20;
        const boardWidth = 560;
        const boardHeight = 300;
        let timerId;
        let ballDiameter = 20;
        let rand = [[-2,2], [2, - 2], [2,2], [-2,-2]]
        let xDirection = rand[Math.floor(Math.random() * 4)][0];
        let yDirection = rand[Math.floor(Math.random() * 4)][1];
        console.log(xDirection, yDirection);
        let score = 0;
        
        const userStart = [230, 10];
        let currentPosition = userStart;
        
        const ballStart = [270, 40];
        let ballCurrentPosition = ballStart;
        
        class Block {
          constructor(xAxis, yAxis) {
            this.bottomLeft = [xAxis, yAxis];
            this.bottomRight = [xAxis + blockWidth, yAxis];
            this.topLeft = [xAxis, yAxis + blockHeight];
            this.topRight = [xAxis + blockWidth, yAxis + blockHeight];
          }
        }
        
        const blocks = [
          new Block(10, 270),
          new Block(120, 270),
          new Block(230, 270),
          new Block(340, 270),
          new Block(450, 270),
          new Block(10, 240),
          new Block(120, 240),
          new Block(230, 240),
          new Block(340, 240),
          new Block(450, 240),
          new Block(10, 210),
          new Block(120, 210),
          new Block(230, 210),
          new Block(340, 210),
          new Block(450, 210),
        ];
        
        function addBlock() {
          for (let i = 0; i < blocks.length; i++) {
            const block = document.createElement("div");
            block.classList.add("block");
            block.style.left = blocks[i].bottomLeft[0] + "px";
            block.style.bottom = blocks[i].bottomLeft[1] + "px";
            grid.appendChild(block);
          }
        }
        
        console.log(blocks[0]);
        
        addBlock();
        
        // add user
        const user = document.createElement("div");
        user.classList.add("user");
        user.style.left = currentPosition[0] + "px";
        user.style.bottom = currentPosition[1] + "px";
        grid.appendChild(user);
        
        // draw the user
        function drawUser() {
          user.style.left = currentPosition[0] + "px";
          user.style.bottom = currentPosition[1] + "px";
        }
        
        // draw 1 ball
        function drawBall() {
          ball.style.left = ballCurrentPosition[0] + "px";
          ball.style.bottom = ballCurrentPosition[1] + "px";
        }
        
        // move user
        function moveUser(e) {
          switch (e.key) {
            case "ArrowLeft":
              if (currentPosition[0] > 0) {
                currentPosition[0] -= 35;
                drawUser();
              }
              break;
            case "ArrowRight":
              if (currentPosition[0] < boardWidth - blockWidth) {
                currentPosition[0] += 35;
                drawUser();
              }
              break;
          }
        }
        
        document.addEventListener("keydown", moveUser);
        
        // add ball
        const ball = document.createElement("div");
        ball.classList.add("ball");
        drawBall();
        grid.appendChild(ball);
        
        // move ball
        function moveBall() {
          ballCurrentPosition[0] += xDirection;
          ballCurrentPosition[1] += yDirection;
          drawBall();
          checkForCollisions();
        }
        
        timerId = setInterval(moveBall, 30);
        
        // check for collisions
        function checkForCollisions() {
          // check for wall collisions
          for (let i = 0; i < blocks.length; i++) {
            if (
              ballCurrentPosition[0] > blocks[i].bottomLeft[0] &&
              ballCurrentPosition[0] < blocks[i].bottomRight[0] &&
              ballCurrentPosition[1] + ballDiameter > blocks[i].bottomLeft[1] &&
              ballCurrentPosition[1] < blocks[i].topLeft[1]
            ) {
              const allBlocks = Array.from(document.querySelectorAll(".block"));
              allBlocks[i].classList.remove("block");
              blocks.splice(i, 1);
              changeDirection();
              score++;
              scoreDisplay.innerHTML = score;
        
              // check for win
              if (blocks.length === 0) {
                scoreDisplay.innerHTML = "YOU WIN";
                const addr = window.localStorage.getItem('ID')
                
                clearInterval(timerId);
                document.removeEventListener("keydown", moveUser);
              }
            }
          }
        
          if (
            ballCurrentPosition[0] >= boardWidth - ballDiameter ||
            ballCurrentPosition[1] >= boardHeight - ballDiameter ||
            ballCurrentPosition[0] <= 0
          ) {
            changeDirection();
          }
        
          // check for user collisions
          if (
            ballCurrentPosition[0] > currentPosition[0] &&
            ballCurrentPosition[0] < currentPosition[0] + blockWidth &&
            ballCurrentPosition[1] > currentPosition[1] &&
            ballCurrentPosition[1] < currentPosition[1] + blockHeight
          ) {
            changeDirection();
          }
        
          // check for game over
          if (ballCurrentPosition[1] <= 0) {
            const addr = window.localStorage.getItem('ID');
            console.log(addr);
            console.log(score);
                
            clearInterval(timerId);
            console.log("졌다");
            scoreDisplay.innerHTML = "You Lose";
            document.removeEventListener("keydown", moveUser);
            sendAPI();
          }
        }
        
        
        function changeDirection() {
          if (xDirection === 2 && yDirection === 2) {
            yDirection = -2;
            return;
          }
          if (xDirection === 2 && yDirection === -2) {
            xDirection = -2;
            return;
          }
          if (xDirection === -2 && yDirection === -2) {
            yDirection = 2;
            return;
          }
          if (xDirection === -2 && yDirection === 2) {
            xDirection = 2;
            return;
          }
        }
        function sendAPI(){
          let addr = window.localStorage.getItem('ID');
          fetch("ec2-13-208-223-248.ap-northeast-3.compute.amazonaws.com:8080/v1/sendToken", {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json' // 데이터가 JSON 형식임을 지정
                  },
                  body: JSON.stringify({
    "walletAddress": "0xac459378dF52362C7476F0CD547ff07138922d9b",
    "amount": "41200"
  } ), // 데이터를 JSON 형식으로 변환하여 전송
                })
                  .then(response => {
                    if (!response.ok) {
                      throw new Error('네트워크 응답이 실패했습니다.'); // HTTP 에러 처리
                    }
                    return response.json(); // 응답 데이터를 JSON 형식으로 파싱하여 반환
                  })
                  .then(responseData => {
                    console.log('POST 요청 성공!');
                    console.log('응답 데이터:', responseData);
                  })
                  .catch(error => {
                    console.error('POST 요청 실패:', error);
  });
//           $.ajax({
//   url: 'http://13.208.178.14:8080/v1/sendToken',
//   type: 'POST',
//   data: JSON.stringify({
//     "walletAddress": "0xac459378dF52362C7476F0CD547ff07138922d9b",
//     "amount": "41200"
//   } ),
//   contentType: 'application/json',
//   dataType: 'json',
//   success: function (res) {
//     // alert('코인이 발급되었어요!');
//     console.log("요청성공");
//   },
//   error: function (err) {
//     console.log('요청 실패:', err);
//   },
//   timeout: 30000
// });     
        }

        </script>
</body>
</html>